<h1>Chương 5: Transactions</h1>
<h4>Introduction</h4>
<p>Transactions là phần quan trọng nhất trong hệ thống bitcoin. Mọi thứ khác trong bỉcoin được thiết kế để đảm bảo giao dịch có thể được tạo, tuyên truyền trên mạng, xác thực và cuối cùng là được thêm vào sổ cái toàn cầu của giao dịch. Transaction là cấu trúc dữ liệu mã hóa việc chuyển giao giá trị giữa những người tham gia trong hệ thống bitcoin. Mỗi giao dịch là một mục nhập công khai trong bitcoin's global double-entry book của bitcoin, giữ sổ kế toán, blockchain/p>
<p>Trong chương này, chúng tôi sẽ xem xét tất cả các form của transaction, những gì chúng chứa, cách tạo chúng, cách chúng được xác minh và cách chúng trở thành một phần của hồ sơ vĩnh viễn của tất cả các giao dịch </p>
<h4>Transaction Lifecycle</h4>
<p>Một vòng đời transaction bắt đầu với tạo transaction, được coi như là nguồn gốc. Tiếp theo là ký với một hoặc nhiều chữ ký cho biết uỷ quyền chi tiêu tiền cho ai đó. Sau đó là quảng bá trên mạng bitcoin, ở đây mỗi node (người tham gia)  xác thực và tuyên truyền giao dịch, cho đến khi nó đạt đến (gần như) mọi nút trong mạng bởi tất cả các node trong mạng. Cuối cùng, giao dịch được xác thực bởi mining node và bao gồm trong một block của transaction mà nó ghi lại trong blockchain</p>
<p>Sau khi được ghi lại trên blockchain và được xác nhận bởi các khối tiếp theo (confirmations), giao dịch là một phần vĩnh viễn của sổ kế toán bitcoin và được chấp nhận là hợp lệ bởi tất cả người tham gia. Tiền được cấp phát cho chủ sở hữu mới bởi giao dịch, sau đó có thể được chi tiêu trong giao dịch mới, mở rộng chuỗi quyền sở hữu và bắt đầu vòng đời của giao dịch một lần nữa. </p>
<h4>Creating Transactions</h4>
<p>Trong một số cách, nó giúp nghĩ về một giao dịch theo cách giống như séc. Giống như séc, giao dịch là công cụ thể hiện ý định chuyển tiền và không hiển thị với hệ thống tài chính cho đến khi nó được gửi để thực thi. Giống như séc, người khởi tạo giao dịch không phải là người kí giao dịch</p>
<p>Các transaction có thể được tạo online hoặc offline bởi bất kỳ ai, thậm chí nếu người tạo transaction không là một người được uỷ quyền trong tài khoản. Ví dụ một nhân viên bán hàng tạo ra séc và tính tiền cần thanh toán và sau đó cần chữ kí của CEO. Tương tự như vậy, một nhân viên có thể tạo ra bitcoin transaction và sau đó CEO sử dụng chữ ký số để xác thực nóTrong khi séc kiểm tra tài khoản cụ thể là nguồn tiền, một giao dịch bitcoin tham chiếu đến một giao dịch cụ thể trước đó như là nguồn của nó, chứ không phải là một tài khoản</p>
<p>Mỗi lần một transaction được tạo, nó được ký bởi chủ sở hữu của nguồn tiền đó. Nếu nó được hình thành và ký hợp đồng đúng cách, giao dịch đã ký hiện đang hợp lệ và chứa tất cả thông tin cần thiết để thực hiện chuyển tiền. Cuối cùng, giao dịch hợp lệ phải đưa ra mạng bitcoin để nó có thể được tuyên truyền cho đến khi nó tới  một thợ mỏ để đưa vào sổ cái pubic, blockchain.</p>
<h4>Broadcasting Transactions to the Bitcoin Network</h4>
<p>Đầu tiên, một transaction cần được giao đến mạng bitcoin sao cho nó có thể tuyên truyền và được bao gồm trong blockchain. Về bản chất, một transaction bitcoin chỉ 300-400 byte dữ liệu và phải tới được một trong hàng chục node bitcoin. Người gửi không cần phải tin tưởng các nút họ sử dụng để tuyên truyền giao dịch, miễn là họ sử dụng nhiều hơn một nút để đảm bảo rằng nó được truyền đi. Các node không cần tin tưởng người gửi hoặc thiệt lập "danh tính" người gửi. Transaction được ký và không chứa thông tin bí mật, private key hoặc thông tin xác thực, nó có thể quảng bá công khai sử dụng vận tải mạng cơ bản mà nó thuận tiện. Không giống giao dịch thẻ tín dụng, ví dụ, cái chứa thông tin nhạy cảm và chỉ có thể được truyền trên mạng mã hoá, một transaction bitcoin có thể được gửi trên bất kỳ mạng nào. Miễn là giao dịch có thể đạt đến một nút bitcoin sẽ truyền nó vào mạng bitcoin, không quan trọng nó được vận chuyển đến nút đầu tiên như thế nào.</p>  
<p>Do đó, các giao dịch Bitcoin có thể được truyền tới mạng bitcoin qua các mạng không an toàn như Wifi, Bluetooth, NFC, Chirp, mã vạch hoặc bằng cách sao chép và dán vào biểu mẫu web. Trong trường hợp cực đoan, một giao dịch bitcoin có thể được truyền qua packet radio, chuyển tiếp vệ tinh hoặc sóng ngắn bằng cách sử dụng truyền phát burst, phổ tần hoặc nhảy tần để tránh phát hiện và gây nhiễu. Giao dịch bitcoin thậm chí có thể được mã hóa dưới dạng biểu tượng mặt cười (biểu tượng cảm xúc) và được đăng trong diễn đàn công khai hoặc được gửi dưới dạng tin nhắn văn bản hoặc tin nhắn trò chuyện qua Skype. Bitcoin đã biến tiền thành một cấu trúc dữ liệu, làm cho nó hầu như không thể ngăn chặn bất kỳ ai  từ tạo đến thực hiện một giao dịch bitcoin</p>
<h4>Propagating Transactions on the Bitcoin Network</h4>
<p>Một lần một transaction bitcoin được gửi đến bất kỳ node nào đó được gửi đến mạng bitcoin, giao dịch sẽ được xác nhận bới node đó.Nếu hợp lệ, nút đó sẽ truyền nó tới các nút khác mà nó được kết nối và một thông báo thành công sẽ được trả về đồng bộ cho người khởi tạo. Nếu giao dịch không hợp lệ, nút sẽ từ chối nó và đồng bộ trả về một thông báo từ chối cho người khởi tạo.</p>
<p>Mạng bitcoin là một mạng peer-to-peer nghĩa là mỗi node bitcoin được kết nối với một vài node bitcoin khác mà nó phát hiện trong suốt quá trình khởi động thông qua giao thức peer-to-peer. Toàn bộ mạng lưới tạo thành một mạng lưới được kết nối lỏng lẻo mà không có cấu trúc liên kết cố định. Thông điệp, bao gồm transaction và blocks, được truyền bá từ mỗi node đến các peers mà nó được kết nối. Một giao dịch được xác thực mới được chèn vào bất kỳ nút nào trên mạng sẽ được gửi đến 3 đến 4 của các nút lân cận, mỗi nút sẽ gửi nó đến 3 đến 4 nút khác và cứ tiếp tục như vậy. Bằng cách này, trong vòng vài giây, một giao dịch hợp lệ sẽ lan truyền trong một gợn mở rộng theo cấp số nhân trên toàn mạng cho đến khi tất cả các nút đã kết nối đã nhận được nó</p>
<p>Mạng bitcoin được thiết kế để truyền bá giao dịch và các khối đến tất cả các node một cách hiệu quả và đàn hồi có khả năng chống lại các cuộc tấn công. Để ngăn chặn spam, tấn công từ chối dịch vụ hoặc các cuộc tấn công phiền toái khác vào hệ thống bitcoin, mỗi nút sẽ độc lập xác thực mọi giao dịch trước khi truyền bá nó. Giao dịch không đúng định dạng sẽ không vượt quá một nút. Các quy tắc mà qua đó các giao dịch được xác thực được giải thích chi tiết hơn trong “Xác minh Giao dịch Độc lập”.</p>
<h4>Transaction Structure</h4>
<p>Một transaction là một data structure mã hóa chuyển giao giá trị từ một nguồn tiền, gọi là một input, đến một destination, gọi là một output. Đầu vào và đầu ra transaction không liên quan đến tài khoản hoặc danh tính. Thay vào đó bạn nên nghĩ về chúng như số bitcoin, khối bitcoin, bị khóa với một bí mật cụ thể mà chỉ có chủ sở hữu, hoặc người biết bí mật, mới có thể mở khóa. Một giao dịch có chứa một số trường, như sau:</p>
<img src="http://sv1.upsieutoc.com/2018/06/18/Screenshot-from-2018-06-18-00-25-10.png" />
<p>Transaction Locktime: Looktime định nghĩa thời gian sớm nhất mà một transaction có thể được thêm vào blockchain. Nó được đặt bằng 0 trong hầu hết các giao dịch để cho biết thực hiện ngay lập tức. Nếu looktime không phải là 0 và dưới 500 triệu, nó được hiểu là một chiều cao khối, nghĩa là giao dịch không bao gồm trong blockchain trước chiều cao khối đã chỉ định. Nếu nó trên 500 triệu, nnó được hiểu là dấu thời gian của Unix Epoch (giây từ tháng 1 đến tháng 1 năm 1970) và giao dịch không được bao gồm trong blockchain trước thời gian quy định. Việc sử dụng thời gian khóa tương đương với kiểm tra hẹn của séc .</p>
<h4>Transaction Outputs and Inputs</h4>
<p>Khối xây dựng cơ bản của giao dịch bitcoin là một unspent transaction output hoặc UTXO. UTXO là các khối không thể tách rời của tiền bitcoin được khoá trong một chủ sở hữu cụ thể, được ghi lại trên chuỗi blockchain, và được công nhận là đơn vị tiền tệ của toàn bộ mạng. Mạng bitcoin theo dõi tất cả các UTXO hiện có (không có) hiện đang đánh số trong hàng triệu. Bất cứ khi nào một người dùng nhận bitcoin, số tiền đó được gi lại trong chuỗi blockchain giống như một UTXO. Do đó, bitcoin của người dùng có thể phân tán dưới dạng UTXO trong số hàng trăm giao dịch và hàng trăm khối. Trong thực tế, không có những thứ như số dư được lưu trữ của một địa chỉ bitcoin hoặc tài khoản; chỉ có UTXO rải rác, được khoá cho chủ sỡ hữu cụ thể. Khái niệm về số dư bitcoin của người dùng là một cấu trúc có nguồn gốc được tạo ra bởi ứng dụng ví. Ví này tính toán số dư của người dùng bằng cách quét chuỗi khối và tổng hợp tất cả UTXO thuộc về người dùng đó.</p>
<i>Không có tài khoản hay số dư trong bitcoin. Nó chỉ là unspent transaction output (UTXO) phân tán trong blockchain.</i>
<p>Một UTXO có thể có một giá trị tùy ý được mệnh danh là bội số của satoshis. Cũng giống như đô la có thể được chia xuống hai chữ số thập phân như xu, bitcoin có thể được chia xuống tám chữ số thập phân như satoshi. Trong khi UTXO có thể là bất kỳ giá trị tùy ý nào, một khi đã tạo ra nó không thể tách rời giống như một đồng xu không thể cắt giảm một nửa. Nếu một UTXO lớn hơn giá trị mong muốn của một giao dịch, nó vẫn phải được tiêu thụ toàn bộ và thay đổi phải được tạo ra trong giao dịch. Nói cách khác, nếu bạn có 20 bitcoin UTXO và muốn trả 1 bitcoin, giao dịch của bạn phải tiêu thụ toàn bộ 20 bitcoin UTXO và tạo ra hai kết quả đầu ra: một bitcoin trả cho người nhận bạn muốn và một bitcoin trả 19 bit khác ví. Kết quả là, hầu hết các hành động chuyển tiền bitcoin sẽ tạo ra thay đổi.</p>
<p>UTXO được tiêu thụ bởi một giao dịch được gọi là giao dịch đầu vào, trong khi UTXO được tạo ra bởi một giao dịch được gọi là kết quả giao dịch. Bằng cách này, khối lượng bitcoin giá trị di chuyển về phía trước từ chủ sở hữu cho chủ sở hữu trong một chuỗi các giao dịch tiêu thụ và tạo ra UTXO. Giao dịch tiêu thụ UTXO mở khóa nó với chữ ký của chủ sở hữu hiện tại và tạo UTXO khóa nó vào địa chỉ bitcoin của chủ sở hữu mới.</p>
<p>Ngoại lệ cho chuỗi đầu ra và đầu vào là một loại giao dịch đặc biệt được gọi là giao dịch coinbase, là giao dịch đầu tiên trong mỗi khối. Giao dịch này được dành cho thợ mỏ “chiến thắng” và tạo ra bitcoin hoàn toàn mới phải trả cho thợ mỏ đó làm phần thưởng cho khai thác mỏ. Đây là cách cung tiền của bitcoin được tạo ra trong quá trình khai thác như chúng ta sẽ thấy trong phần “Giới thiệu” ở trang 177.</p>
<h4>Transaction Outputs</h4>
<p>Mỗi transaction bitcoin tạo output, cái mà được ghi lại trên sổ cái bitcoin. Hầu như tất cả các đầu ra này với một ngoại lệ (xem “Dữ liệu đầu ra (OP_RETURN)” trên trang 133) tạo ra các khối chi tiêu bitcoin được gọi là unspent transaction outputs or UTXO, sau đó được toàn bộ mạng công nhận và có sẵn để chủ sở hữu chi tiêu trong một giao dịch trong tương lai. Gửi một người nào đó bitcoin đang tạo ra unspent transaction output (UTXO) được đăng kí với address của họ và có sẵn  để gửi</p>
<p>UTXO được theo dõi bởi tất cả full node bitcoin client trong cơ sở dữ liệu được lưu trữ bộ nhớ. Gọi là tập UTXO set hoặc UTXO pool. Transaction mới tiêu thụ từ một hoặc nhiều đầu ra từ tập UTXO</p>
<p>Transaction output bao gồm 2 phần: </p>
<li>Một số bitcoin được tính bằng satoshi, đơn vị nhỏ nhất bitcoin</li>
<li>Một kịch bản khóa, còn được gọi là "encumbrance" mà "locks" số tiền này bằng cách xác định nếu các điều kiện phải được đáp ứng để chi tiêu đầu ra</li>
<p>Ngôn ngữ transaction scripting language, được sử dụng trong locking script đề cập trên, được thảo luận chi tiết trong "Transaction Scripts and Script Language"</p>
<img src="http://sv1.upsieutoc.com/2018/06/20/Screenshot-from-2018-06-20-15-54-31.png" />
<p>Trong ví dụ bên dưới, chúng ta sử dụng API của blockchain.info để tìm unspent output (UTXO) của một địa chỉ cụ thể: </p>
<img src="http://sv1.upsieutoc.com/2018/06/20/Screenshot-from-2018-06-20-16-00-03.md.png" />
<img src="http://sv1.upsieutoc.com/2018/06/20/Screenshot-from-2018-06-20-16-01-10.md.png" />
<h5>Spending Conditions (Encumbrances)</h5>
<p>Transaction outputs liên kết với một số tiền cụ thể (trong satoshis) với một  encumbrance hoặc looking-script mà nó định nghĩa điều kiện phải đáp ứng để gửi số tiền đó. Trong tất cả các trường hợp, locking script sẽ lock đầu ra vào một địa chỉ bitcoin cụ thể, do đó chuyển quyền sở hữu số tiền đó cho chủ sở hữu mới. </p>
<p>Khi Alice trả tiền cho tách cà phê của Cafe bod, giao dịch của cô ấy tạo đầu ra 0.015 bitcoin hoặc khoá vào địa chỉ bitcoin Cafe. Đầu ra 0.015 bitcoin được ghi lại trên chuỗi blockchain và trở thành một phần của tập Unspent Transaction Output, nghĩa là nó trở thành số tiền của Bod. Khi Bod chọn gửi số tiền đó, giao dịch của anh ấy sẽ giải phóng encumbrance, mở khoá đầu ra bằng cái cung cấp unlocking script chứa một chữ kí từ private key của Bod.</p>
<h4>Transaction Inputs</h4>
<p>Nói một cách đơn giản, đầu vào transaction là con trỏ trỏ tới UTXO. Chúng ta trỏ tới một UTXO cụ thể bởi tham chiếu transaction hash và số thứ tự, cái mà UTXO được ghi lại trong Blockchain. Để gửi UTXO, một đầu vào transactioncũng bao gồm unlocking-script thoả mãn các điều kiện spending conditions bởi UTXO. Unlocking script thường có một chữ kí chứng minh quyền sở hữu địa chỉ bitcoin, cái mà nó trong locking script</p>
<p>Khi một người dùng thanh toán, ví của họ tạo một transaction bởi lựa chọn từ UTXO có sẵn. Ví dụ, để thanh toán 0.015 bitcoin, app ví của bạn phải lựa chọn 0.01 UTXO và một 0.005 UTXO, sử dụng cả 2 để thêm vào số tiền mong muốn. </p>
<p>Trong ví dụ bên dưới, chúng tôi cho thấy việc sử dụng thuật toán "tham lam" để chọn từ UTXO có sẵn để thực hiện một số tiền thanh toán cụ thể.</p>
<a href="https://imgbb.com/"><img src="https://image.ibb.co/kvKSLJ/Screenshot_from_2018_06_20_16_35_32.png" alt="Screenshot from 2018 06 20 16 35 32" border="0" /></a> 
<a href="https://imgbb.com/"><img src="https://image.ibb.co/drxxLJ/Screenshot_from_2018_06_20_16_37_20.png" alt="Screenshot_from_2018_06_20_16_37_20" border="0"></a>
<h4>Transaction Fees</h4>
<p>Phí cho một giao dịch là tự nguyện, thông thường là 0.0001 BTC. Bạn có thể trả thêm phí để hấp dẫn hơn các miner, giúp giao dịch mau được kiểm chứng hơn.</p>
<h4>Adding Fees to Transaction</h4>
<p>Fees = Sum(Inputs) - Sum(Outputs)</p>
<h4>Transaction Chaining and Orphan Transaction</h4>
<p>Như chúng ta thấy ở trên, các transaction tạo thành 1 chuỗi, theo đó một transaction gửi đầu ra của transaction trước (được biết như parent) và tạo đầu ra của một giao dịch tiếp theo (được biết như một child). Đôi khi toàn bộ chuỗi giao dịch tùy thuộc vào nhau, giả sử giao dịch cha mẹ, con và cháu được tạo cùng một lúc, để hoàn thành quy trình giao dịch phức tạp yêu cầu trẻ hợp lệ được ký trước khi cha mẹ được ký. </p>
<h4>Script Construction (Lock + Unlock) </h4>
<p>Phương pháp xác thực transaction của bitcoin phục thuộc vào 2 loại script xác thực transactions là : locking script và unlocking script. Locking Script là một điều kiện được đặt trong output và nó chỉ định các điều kiện phải gặp để gửi output trong tương lai. Trong lịch sử, locking script được xem như một ScriptPubKey, bởi vì nó thường chứa một public key hoặc bitcoin address. Trong quyển sách này, chúng ta tham chiếu đến nó như một "locking script" để thừa nhận phạm vi rộng hơn khả năng của công nghệ script này. Trong tất cả ứng dụng bitcoin, những gì chúng tôi gọi là locking script sẽ xuất hiện trong source code như "scriptPubKey" </p>
<p>Một unlocking script là một script "solves" hoặc thoả mãn điều kiện trong một output để gửi. Unlocking script là một phần của mọi transaction input và chứa một chữ ký số được sinh bởi ví người dùng từ private key. Unlocking script được gọi là scriptSig, bởi vì nó thường chứa một chữ ký số. Trong quyển sách này. Trong hầu hết ứng dụng bitcoin, source code sẽ tham chiếu đến unlocking script như "scriptSig".  </p>
<p>Mọi máy khách bitcoin sẽ xác nhận transaction bởi thực thi locking và unlocking script. Với mỗi input trong transaction, phần mềm xác thực sẽ nhận UTXO bởi tham chiếu input. UTXO ở đây chứa một locking script định nghĩa ra điều kiện yêu cầu để gửi nó. Phần mềm xác thực sau đó sẽ unlocking script chứa input và cố gắng để gửi UTXO này và thực thi 2 script.</p>
<p>Trong máy khách bitcoin ban đầu, các kịch bản mở khóa và khóa được nối và thực hiện theo thứ tự. Vì lý do bảo mật, nó được thay đổi vào năm 2010, bởi vì một lổ hổng mà cho phép một unlocking script không đúng định dạng đẩy dữ liệu vào stack và làm hỏng locking script. Script triển khai hiện tại được thực thi tách rời với ngăn xếp được chuyển giữa 2 thực thi, giống như diễn tả bên dưới.</p>
<p>Đầu tiên, unlocking script được thực thi, sử dụng công cụ thực thi stack. Nếu unlocking script được thực thi với không lỗi, ngăn xếp chính (không phải ngăn xếp thay thế) được sao chép và tập lệnh khóa được thực hiện. Nếu kết qủa cả thực thi locking script với stack data sao chép từ unlocking script là "TRUE", the unlocking script thành công trong việc giải quyết các điều kiện do locking script  áp đặt và do đó  input là uỷ quyền hợp lệ để gửi UTXO. Nếu bất kỳ kết quả nào khác ngoài “TRUE” vẫn còn sau khi thực thi tập lệnh kết hợp, the input là không hợp lệ và nó lỗi để thoả mãn spending conditions được đặt vào UTXO. Chú ý rằng UTXO là bản ghi vĩnh cửu trong blockchain và do đó không thay đổi và  không bị ảnh hưởng bởi những nỗ lực thất bại để gửi nó bởi tham chiếu đên một new transaction. Chỉ một giao dịch hợp lệ đáp ứng chính xác các điều kiện của kết quả UTXO trong UTXO được đánh dấu là "đã chi tiêu" và bị xóa khỏi tập hợp UTXO hiện có (không có).</p>
<p>Bên dưới là ví dụ của unlocking và looking script cho đa số các loại bitcoin transaction ( một thanh toán cho một public key hash), chỉ ra kết quả script kêys hợp từ việc ghép nối unlocking và locking script trước khi xác thực script</p>
<a href="https://ibb.co/j13rVJ"><img src="https://preview.ibb.co/ecyQqJ/Screenshot_from_2018_06_20_23_39_05.png" alt="Screenshot_from_2018_06_20_23_39_05" border="0"></a>


<h1>Chương 6: The Bitcoin Network </h1>
<h4>Peer-to-Peer Network Architecture</h4>
<p>Bitcoin được xây dựng trên mạng peer-to-peer. P2P nghĩa là các máy tín tham gia trên mạng là các peers được kết nối đến các peer khác, chúng là đồng đẳng và không có một nodes đặc biệt nào và tất cả các node chia sẽ gánh nặng của việc cung cấp dịch vụ mạng. Các node mạng kết nối với nhau trong một lưới mạng với cấu trúc liên kết "bằng phẳng (flat)". Không có server, không tập trung. Các mạng ngang hàng vốn có khả năng đàn hồi, không tập trung và mở. Ngoài bitcoin, ứng dụng công nghệ P2P lớn nhất và thành công nhất là chia sẻ tập tin với Napster là người tiên phong và bittorrent là sự phát triển mới nhất của kiến ​​trúc.</p>
<p>Bitcoin là một hệ thống tiền mặt kỹ thuật số ngang hàng theo thiết kế, và kiến ​​trúc mạng là cả một sự phản ánh và nền tảng của đặc tính cốt lõi đó. Điều khiển phi tập trung là một nguyên tắc thiết kế lõi và chỉ có thể thi hành và duy trì bằng một mạng lưới phi tập trung và có cơ chế đồng thuận về mạng trong mạng đó. </p>
<p>Thuật ngữ “mạng bitcoin” đề cập đến tập hợp các nút chạy giao thức bitcoin P2P. Ngoài giao thức bitcoin P2P, có các giao thức khác chẳng hạn như Stratum, cái được sử dụng cho mining và lightweight hoặc mobile wallets. Các giao thức bổ sung này được cung cấp bởi các máy chủ định tuyến cổng truy cập mạng bitcoin bằng giao thức bitcoin P2P và sau đó mở rộng mạng đó tới các nút đang chạy các giao thức khác. Ví dụ, các máy chủ Stratum kết nối các nút mining Stratum thông qua giao thức Stratum với mạng bitcoin chính và nối giao thức Stratum với giao thức bitcoin P2P. Chúng tôi sử dụng thuật ngữ "mạng bitcoin mở rộng" để chỉ mạng tổng thể bao gồm giao thức bitcoin P2P, giao thức khai thác pool, giao thức Stratum và bất kỳ giao thức liên quan nào khác kết nối các thành phần của hệ thống bitcoin</p>
<h4>Các kiểu node và vai trò</h4>
<p>Trong khi các nút trong mạng P2P bitcoin đồng đẳng, chúng có thể thực hiện các “vai trò” khác nhau tùy thuộc vào chức năng mà chúng đang hỗ trợ. Một node bitcoin là một tập hợp các chức năng: routing, the blockchain database, mining, và wallet services. Một full node với 4 chức năng bên dưới: </p>
<a href="https://ibb.co/b5tJeo"><img src="https://preview.ibb.co/iXQ9kT/Screenshot_from_2018_06_21_10_25_48.png" alt="Screenshot_from_2018_06_21_10_25_48" border="0"></a>
<p>Tất cả các node bao gồm chức năng routing để tham gia vào mạng và có thể bao gồm các chức năng khác. Tất cả các node xác thực và quảng bá giao dịch và block, và loại bỏ và duy trì kết nối với các peers. Trong ví dụ full node ở trên, routing function được biểu thị bởi vòng tròn màu da cam có tên là "Network Routing Node"</p>
<p>Một vài node, gọi là full nodes, cũng duy trì một bản sao hoàn chỉnh và cập nhật của blockchain. Các nút Full nodes có thể tự chủ và xác minh quyền tác giả bất kỳ giao dịch nào mà không có tham chiếu bên ngoài. Một vài node duy trì chỉ một tập con của blockchain và xác thực transaction sử dụng một phương thực gọi là Simplified Payment Verification or SPV. Những cái node này được biết đến như SPV hoặc Lightweight nodes. Trong ví dụ full node ở trên, the full node blockchain database function được chỉ ra bởi một vòng tròn blue có tên là "Full Blockchain". SPV nodes được vẽ thiếu vòng trong blue circle. chỉ ra răng chúng không có một bản sao đầy đủ của blockchain</p>
<p>Mining nodes cạnh tranh để tạo ra block mới bởi chạy bằng các phần cức chuyên dụng để giải thuật toán bằng chứng công việc (proof-of-work). Một vài nodes mining cũng là full nodes, duy trì một bản sao chép đầy đủ của blockchain trong khi các node khác là lightweight nodes tham gia trong pool mining và phụ thuộc vào một pool server để duy trì một full node. The mining function được chỉ ra ở full node trên là một black circle named "Miner".</p>
<p>Ví người dùng là một phần của một full node, như thường là trường hợp của máy khách bitcoin để bản. Càng ngày càng nhiều người dùng ví, đặc biệt là những người đang chạy trên các thiết bị có nguồn lực hạn chế như điện thoại thông minh, là các SPV nodes. The wallet function được chỉ ra trên là một vòng tròn màu xanh tên là "Wallet".</p>
<p>Ngoài các loại nút chính trên giao thức bitcoin P2P, các server và các node chạy trên các giao thức khác nhau, chẳng hạn giao thức chuyên mining pool và giao thức truy cập lightweight client.</p>
<p>Dưới đây là các node phổ biến trong mạng bitcoin mở rộng:</p>
<a href="https://imgbb.com/"><img src="https://image.ibb.co/mabzKo/Screenshot_from_2018_06_21_14_33_04.png" alt="Screenshot_from_2018_06_21_14_33_04" border="0"></a>
<h4>The Extended Bitcoin Network</h4>
<p>Mạng bitcoin chính, chạy giao thức bitcoin P2P, bao gồm 7000 đến 10000 nodes chạy đa dạng các version của bitcoin core và  một vài trăm nút chạy các triển khai khác nhau của giao thức bitcoin P2P  chẳng hạn như BitcoinJ, Libbitcoin và btcd. Một tỷ lệ nhỏ các nút trên mạng P2P bitcoin cũng là các nút đào ,cạnh tranh trong quá trình đào, xác thực giao dịch và tạo block mới. Nhiều công ty lớn giao tiếp với mạng bitcoin bởi chạy máy khách full-node dựa trên Bitcoin Core client, với đầy đủ bản sao chép của blockchain và một node mạng, nhưng thiếu đi mining hoặc wallet function. Những node này hoạt động như các bộ định tuyến cạnh mạng, cho phép các dịch vụ khác (exchange, wallet, block explorers, merchant payment processing) </p>
<p>Mạng bitcoin mở rộng bao gồm mạng chạy giao thức bitcoin P2P, diễn tả ở trên, cũng như các node chạy giao thức đặc biệt. Đính kèm với mạng bitcoin P2P chính là số của pool server và cổng giao thức kết nối node chạy giao thức khác. Các node giao thứ khác đa số là pool mining nodes và lightweight wallet client, cái không mang theo một bản sao đầy đủ của blockchain. </p>
<p>Biểu đồ bên dưới chỉ ra mạng bitcoin mở rộng với đa dạng các node, gateway server, edge router, và wallet client và đa dạng các giao thức họ sử dụng để kết nối với cái khác.</p>
<a href="https://ibb.co/mpxH5T"><img src="https://preview.ibb.co/dEhTC8/Screenshot_from_2018_06_21_15_11_25.png" alt="Screenshot_from_2018_06_21_15_11_25" border="0"></a>
<h4>Network Discovery</h4>
<p>Khi một node mới khởi động, nó phải được phát hiện bởi các node bitcoin khác trên mạng để tham gia. Bắt đầu, một new node phải khám phá ít nhất một node tồn tại trên mạng và kết nối với nó. Vị trí của các node khác trên địa lý là không liên quan, cấu trúc liên kết mạng bitcoin không được xác định theo địa lý.Do đó, bất kỳ tồn tại bitcoin node có thể được chọn ngẫu nhiên.</p>
<p>Để kết nối đến một peer đã biết, node thiết lập một kết nối TCP, thường cổng 8333 hoặc một cổng thay thế nếu cổng đó đã dùng. Sau khi thiết lập kết nối, node sẽ bắt tay với một "handshake" bởi truyền một thông báo phiên bản, chứa thông tin nhận dạng cơ bản, bao gồm: </p>
<li>PROTOCOL_VERSION, một hằng số định nghĩa version giao thức bitcoin P2P</li>
<li>nLocalService, một danh sách local services được cung cấp bới node, hiện tại chỉ NODE_NETWORK</li>
<li>nTime, current time</li>
<li>addrYou, địa chỉ IP của nút từ xa như được thấy từ nút này</li>
<li>addrMe, địa chỉ IP của local node, như được phát hiện bởi local node.</li>
<li>subver, một sub-version hiển thị kiểu phần mềm chạy node này (vd: satoshi:0.9.2.1/")</li>
<li>BestHeight: block height của node's blockchain</li>
<p>Nút ngang hàng đáp ứng với verack để xác nhận và thiết lập một kết nối, và tùy chọn gửi thông điệp phiên bản của riêng nó nếu nó muốn đáp lại kết nối và kết nối lại như một peer.</p>
<a href="https://imgbb.com/"><img src="https://image.ibb.co/f0P3eo/Screenshot_from_2018_06_21_15_51_09.png" alt="Screenshot_from_2018_06_21_15_51_09" border="0"></a>
<p>Một new node tìm peers như thế nào? Trong khi không có node đặc biết nào trong bitcoin, có một số node được liệt kê trong máy client dươi dạng seed node. Trong khi một new node không kết nói với seed nodes, nó cần sử dụng chúng để nhanh chóng phát hiện các node khác trên mạng. Trong máy Bitcoin core client, điều kiện để sử dụng seed nodes là điều khiển bởi switch -dnsseed, cái được đặt bằng 1 để sử dụng các seed nodes. Ngoài ra, một nút bootstrapping mà không biết gì về mạng phải được cung cấp địa chỉ IP của ít nhất một nút bitcoin sau đó nó có thể thiết lập các kết nối thông qua các phần giới thiệu thêm. Tham số cmd -seednode có thể được sử dụng để kết nối đén một node giới thiệu, sử dụng nó như một DNS seed. Sau khi seed node ban đầu được sử dụng để tạo thành phần giới thiệu, client sẽ huỷ kết nối nó và sử dụng các peers mới đc phát hiện</p>
<p>Khi một hoặc nhiều kết nối được thiết lập, new node sẽ gửi một thông điệp addr chứa IP của nó tới các node láng giếng. Các node láng giềng sẽ lần lượt chuyển tiếp thông điệp addr đến hàng xóm của họ, đảm bảo rằng nút mới được kết nối trở nên nổi tiếng và được kết nối tốt hơn. Thêm vào đó, node kết nối mới có thể gửi getaddr đến hàng xóm, hỏi chúng để trả về một list địa chỉ IP của các peer khác. Theo cách đó, một node có thể tìm các peer để kết nối và quảng cáo sự tồn tại của nó trên mạng để các nút khác tìm thấy nó.</p>
<a href="https://ibb.co/fQrGFT"><img src="https://preview.ibb.co/h5AnN8/Screenshot_from_2018_06_21_16_18_15.png" alt="Screenshot_from_2018_06_21_16_18_15" border="0"></a>
<p>Một node phải kết nối với một vài peer khác để thiết lập đường dẫn đa dạng vào mạng bitcoin. Đường dẫn không đáng tin cậy, các nút đến và đi, và vì vậy nút phải tiếp tục khám phá các nút mới vì nó mất kết nối cũ cũng như hỗ trợ các nút khác khi chúng khởi động. Chỉ cần một kết nối để khởi động, vì nút đầu tiên có thể cung cấp lời giới thiệu cho các nút ngang hàng của nó và các đồng nghiệp đó có thể cung cấp thêm phần giới thiệu. Nó cũng không cần thiét và lãng phí tài nguyên mạng để kết nối với nhiều hơn một số nút. Sau khi khởi động, mỗi node sẽ nhớ các kết nối thành công gần nhất,để nếu nó được khởi động lại, nó có thể nhanh chóng thiết lập lại các kết nối với mạng ngang hàng cũ của nó. Nếu không ai trong số các đồng nghiệp cũ đáp ứng yêu cầu kết nối của nó, nút có thể sử dụng các nút seed node để khởi động lại. </p>
<p>Trong một node chạy Bitcoin Core client, bạn có thể liệt kê các kết nối peer với cmd getpeerinfo: </p>
<a href="https://ibb.co/dhoXN8"><img src="https://preview.ibb.co/gQZTvT/Screenshot_from_2018_06_21_16_51_54.png" alt="Screenshot_from_2018_06_21_16_51_54" border="0"></a>
<a href="https://ibb.co/iCNL9o"><img src="https://preview.ibb.co/gHdtUo/Screenshot_from_2018_06_21_16_52_07.png" alt="Screenshot_from_2018_06_21_16_52_07" border="0"></a>
<h4>Full Nodes</h4>
<p>Full Nodes là các node duy trì một full blockchain với tất cả transaction. Chính xác hơn, có lẽ nên được gọi là "full blockchain nodes". Trong những năm đầu của Bitcoin, tất cả các node là full nodes và hiện tại The Bitcoin Core client là một full blockchain node. Tuy nhiên, trong 2 năm qua, dạng mới của bitcoin client được giới thiệu không duy trì một full blockchain nhưng chạy như lightweight clients.  Cái này được xem xét trong phần tiếp theo.</p>
<p>Các node Full blockchain duy trì một bản sao chép hoàn chỉnh và cập nhật của bitcoin blockchain với tất cả các transaction, Chúng độc lập xây dựng và xác thực, bắt đầu với block đầu tiên (genesis block) và xây dựng lên đến khối mới nhất được biết đến trên mạng. Một full blockchain node có thể độc lập và xác thực độc quyền bất kỳ transaction mà không trông cậy hoặc phụ thuộc vào bất kì thông tin của nút hoặc nguồn nào khác. Node full blockchain phụ thuộc mạng để nhận update về new block của các giao dịch, sau đó nó xác minh và kết hợp vào bản sao cục bộ của blockchain.</p>
<p>Chạy một node full blockchain sẽ cho bạn một trải nghiệm tinh khiết: độc lập xác thực các transaction mà không cần dựa vào hoặc tin tưởng bất kì hệ thống nào khác. Thật dễ dàng để biết liệu bạn có đang chạy một nút đầy đủ hay không vì nó yêu cầu 20 gigabyte lưu trữ liên tục (dung lượng đĩa) để lưu trữ blockchain đầy đủ. Nếu bạn cần nhiều đĩa và phải mất 2-3 ngày để "đồng bộ" với mạng, bạn đang chạy một nút đầy đủ. Đó là giá độc lập hoàn toàn và tự do khỏi chính quyền trung ương</p>
<p>Có một vài triển khai thay thế của các full-blockchain bitcoin client, được xây dựng bằng cách sử dụng các ngôn ngữ lập trình và kiến ​​trúc phần mềm khác nhau. Tuy nhiên, việc thực hiện phổ biến nhất là tham khảo Bitcoin Core client, còn được gọi là Satoshi client. Hơn 90% các node trên mạng bitcoin chạy version khác nhau của Bitcoin Core. Nó được xác định là "Satoshi" trong chuỗi phiên bản phụ được gửi trong thông báo phiên bản và được hiển thị bằng lệnh getpeerinfo như chúng ta đã thấy ở trên, ví dụ / Satoshi: 0.8.6 /.</p>
<h4>Bloom Filter</h4>
<p>N binary digit, M hash functions</p>
